pipeline {
    agent {
        kubernetes {
            defaultContainer 'jdk'
            yaml '''
apiVersion: v1
kind: Pod
spec:
  containers:
    - name: jdk
      image: docker.io/eclipse-temurin:20.0.1_9-jdk
      command:
        - cat
      tty: true
      volumeMounts:
        - name: m2-cache
          mountPath: /root/.m2
    - name: podman
      image: quay.io/containers/podman:v4.5.1
      command:
        - cat
      tty: true
      securityContext:
        runAsUser: 0
        privileged: true
    - name: kubectl
      image: docker.io/bitnami/kubectl:1.27.3
      command:
        - cat
      tty: true
      securityContext:
        runAsUser: 0
        privileged: true
  volumes:
    - name: m2-cache
      hostPath:
        path: /data/m2-cache
        type: DirectoryOrCreate
    - name: shared-data
      hostPath:
        path: /path/to/shared/folder
        type: DirectoryOrCreate
'''
        }
    }

    environment {
        PUSHGATEWAY_URL = 'pushgateway:9091'
        WEBSITE_URL = 'https://www.accenture.com/es-es'
        JOB_NAME = 'accenture_es_es'
    }

    stages {
       
        stage('Parse Katalon XML') {
            steps {
                script {
                    // Asumiendo que katalon.xml está en el directorio actual
                    def katalonXml = readFile('katalon.xml')
                    def parsedXml = new XmlSlurper().parseText(katalonXml)

                    // Recogiendo las métricas del XML
                    def totalTests = parsedXml.'@tests'.text().toInteger()
                    def totalFailures = parsedXml.'@failures'.text().toInteger()
                    def totalErrors = parsedXml.'@errors'.text().toInteger()
                    def totalTime = parsedXml.'@time'.text().toFloat()

                    // Aquí comienza la construcción del string para Prometheus
                    def prometheusData = """
# HELP katalon_total_tests Total number of tests
# TYPE katalon_total_tests gauge
katalon_total_tests ${totalTests}

# HELP katalon_total_failures Total number of failed tests
# TYPE katalon_total_failures gauge
katalon_total_failures ${totalFailures}

# HELP katalon_total_errors Total number of errors in tests
# TYPE katalon_total_errors gauge
katalon_total_errors ${totalErrors}

# HELP katalon_total_time Total time of test suite execution
# TYPE katalon_total_time gauge
katalon_total_time ${totalTime}
"""

                    // Escribir las métricas en un archivo para Prometheus
                    writeFile(file: 'katalon.prom', text: prometheusData)
                }
            }
        }
/*
        stage('Send to Prometheus') {
            steps {
                prometheus([
                    jobName: 'katalon',
                    scrapeInterval: '1m',
                    scrapeTimeout: '10s',
                    metricsPath: '/metrics',
                    pushGatewayUrl: 'http://prometheus-pushgateway:9091',
                    pushGatewayJobName: 'katalon',
                    credentialsId: 'prometheus-pushgateway-credentials'
                ]) {
                    sh 'cat katalon.prom | curl --data-binary @- http://prometheus-pushgateway:9091/metrics/job/katalon'
                }
            }
        }*/
    }
}
